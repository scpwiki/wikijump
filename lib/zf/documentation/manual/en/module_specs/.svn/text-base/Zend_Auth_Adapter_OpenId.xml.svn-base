<sect1 id="zend.auth.adapter.openid">

    <title>Open ID Authentication</title>

    <sect2 id="zend.auth.adapter.openid.introduction">

        <title>Introduction</title>
        <para>
            The <code>Zend_Auth_Adapter_OpenId</code> adapter can be used to authenticate users using
            remote OpenID servers. This authentication method assumes that the user
            submits only their OpenID identity to the web application. They are
            then redirected to their OpenID provider to prove identity ownership
            using a password or some other method. This password is never provided to
            the web application.
        </para>
        <para>
            The OpenID identity is just a URI that points to a web site
            with information about a user, along with special tags that
            describes which server to use and which identity to submit there.
            You can read more about OpenID at the
            <ulink url="http://www.openid.net/">OpenID official site</ulink>.
        </para>
        <para>
            The <code>Zend_Auth_Adapter_OpenId</code> class wraps
            the <code>Zend_OpenId_Consumer</code> component, which implements the
            OpenID authentication protocol itself.
        </para>

        <note>
            <para>
                <code>Zend_OpenId</code> takes advantage of the <ulink url="http://php.net/gmp">GMP extension</ulink>,
                where available. Consider enabling the GMP extension for better performance when using
                <code>Zend_Auth_Adapter_OpenId</code>.
            </para>
        </note>
    </sect2>

    <sect2 id="zend.auth.adapter.openid.specifics">
        <title>Specifics</title>
        <para>
            As is the case for all <code>Zend_Auth</code> adapters, the <code>Zend_Auth_Adapter_OpenId</code>
            class implements <code>Zend_Auth_Adapter_Interface</code>, which
            defines one method: <code>authenticate()</code>. This method performs
            the authentication itself, but the object must be prepared prior to
            calling it. Such adapter preparation includes setting up the OpenID
            identity and some other <code>Zend_OpenId</code> specific options.
        </para>

        <para>
            However, as opposed to other <code>Zend_Auth</code> adapters, <code>Zend_Auth_Adapter_OpenId</code>
            performs authentication on an external server in two
            separate HTTP requests. So the <code>Zend_Auth_Adapter_OpenId::authenticate()</code> method
            must be called twice. On the first invocation the method won't return, but will
            redirect the user to their OpenID server. Then after the user is authenticated on the remote
            server, they will be redirected back and the script for this second
            request must call <code>Zend_Auth_Adapter_OpenId::authenticate()</code>
            again to verify the signature which comes with the redirected request from the
            server to complete the authentication process. On this second invocation, the
            method will return the <code>Zend_Auth_Result</code> object as expected.
        </para>

        <para>
            The following example shows the usage of <code>Zend_Auth_Adapter_OpenId</code>.
            As previously mentioned, the <code>Zend_Auth_Adapter_OpenId::authenticate()</code>
            must be called two times. The first time is after the user submits the HTML form with the
            <code>$_POST['openid_action']</code> set to <code>"login"</code>,
            and the second time is after the HTTP redirection from OpenID server with
            <code>$_GET['openid_mode']</code> or <code>$_POST['openid_mode']</code>
            set.
        </para>

        <programlisting role="php"><![CDATA[
<?php
$status = "";
$auth = Zend_Auth::getInstance();
if ((isset($_POST['openid_action']) &&
     $_POST['openid_action'] == "login" &&
     !empty($_POST['openid_identifier'])) ||
    isset($_GET['openid_mode']) ||
    isset($_POST['openid_mode'])) {
    $result = $auth->authenticate(
        new Zend_Auth_Adapter_OpenId(@$_POST['openid_identifier']));
    if ($result->isValid()) {
        $status = "You are logged in as "
                . $auth->getIdentity()
                . "<br>\n";
    } else {
        $auth->clearIdentity();
        foreach ($result->getMessages() as $message) {
            $status .= "$message<br>\n";
        }
    }
} else if ($auth->hasIdentity()) {
    if (isset($_POST['openid_action']) &&
        $_POST['openid_action'] == "logout") {
        $auth->clearIdentity();
    } else {
        $status = "You are logged in as "
                . $auth->getIdentity()
                . "<br>\n";
    }
}
?>
<html><body>
<?php echo htmlspecialchars($status);?>
<form method="post"><fieldset>
<legend>OpenID Login</legend>
<input type="text" name="openid_identifier" value="">
<input type="submit" name="openid_action" value="login">
<input type="submit" name="openid_action" value="logout">
</fieldset></form></body></html>
*/
]]>
        </programlisting>

        <para>
            You may customize the OpenID authentication process in several way.
            You can, for example, receive the redirect from the OpenID server on a separate page,
            specifying the "root" of web site and using a custom
            <code>Zend_OpenId_Consumer_Storage</code> or a custom
            <code>Zend_Controller_Response</code>. You may also use
            the Simple Registration Extension to retrieve information about
            user from the OpenID server. All of these possibilities are described
            in more detail in the <code>Zend_OpenId_Consumer</code>
            chapter.
        </para>

    </sect2>
</sect1>
<!--
vim:se ts=4 sw=4 et:
-->